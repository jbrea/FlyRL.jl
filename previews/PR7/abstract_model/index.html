<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Abstract Model · FlyRL.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">FlyRL.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Introduction</a></li><li><span class="tocitem">Examples</span><ul><li class="is-active"><a class="tocitem" href>Abstract Model</a><ul class="internal"><li><a class="tocitem" href="#Loading-the-data"><span>Loading the data</span></a></li><li><a class="tocitem" href="#Preprocessing-the-data"><span>Preprocessing the data</span></a></li><li><a class="tocitem" href="#Fitting-a-reinforcement-learning-agent"><span>Fitting a reinforcement learning agent</span></a></li><li><a class="tocitem" href="#Generate-simulated-data"><span>Generate simulated data</span></a></li><li><a class="tocitem" href="#Model-fitting-for-data-analysis"><span>Model-fitting for data analysis</span></a></li></ul></li><li><a class="tocitem" href="../detailed_model/">Detailed Model</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../io/">Loading Files</a></li><li><a class="tocitem" href="../encoders/">Encoders</a></li><li><a class="tocitem" href="../models/">Models</a></li><li><a class="tocitem" href="../fitting/">Fitting</a></li><li><a class="tocitem" href="../simulations/">Simulations</a></li><li><a class="tocitem" href="../summary_stats/">Summary Statistics</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Abstract Model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Abstract Model</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/jbrea/FlyRL.jl/blob/main/docs/src/abstract_model.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Fitting-a-reinforcement-learning-model-to-an-abstract-representation-of-the-data"><a class="docs-heading-anchor" href="#Fitting-a-reinforcement-learning-model-to-an-abstract-representation-of-the-data">Fitting a reinforcement learning model to an abstract representation of the data</a><a id="Fitting-a-reinforcement-learning-model-to-an-abstract-representation-of-the-data-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting-a-reinforcement-learning-model-to-an-abstract-representation-of-the-data" title="Permalink"></a></h1><h2 id="Loading-the-data"><a class="docs-heading-anchor" href="#Loading-the-data">Loading the data</a><a id="Loading-the-data-1"></a><a class="docs-heading-anchor-permalink" href="#Loading-the-data" title="Permalink"></a></h2><p>This is an example where we first encode the data to an abstract form and then fit a policy gradient reinforcement learning method.</p><p>First we load the data and plot one recording.</p><pre><code class="language-julia hljs">using FlyRL, DataFrames
import FlyRL: read_directory, plot_track

tracks = FlyRL.read_directory(&quot;data/dgrp_362/dgrp362_shock&quot;,
                              drop_outliers = true,
                              pattern = r&quot;^track&quot;,
                              warn_outliers = false);

plot_track(tracks[end])</code></pre><p><img src="../images/track1.png" alt/></p><p>Blue and green indicate the color of the arm, yellow dots indicate shocks and gray indicates the center of the maze.</p><h2 id="Preprocessing-the-data"><a class="docs-heading-anchor" href="#Preprocessing-the-data">Preprocessing the data</a><a id="Preprocessing-the-data-1"></a><a class="docs-heading-anchor-permalink" href="#Preprocessing-the-data" title="Permalink"></a></h2><p>Now we define a preprocessor of the raw data.</p><pre><code class="language-julia hljs">import FlyRL: Preprocessor, ShockArmEncoder, DynamicCompressEncoder, MarkovKEncoder,
              VectorEncoder, LevelEncoder, preprocess

preprocessor = Preprocessor(input = ShockArmEncoder() |&gt;
                                    x -&gt; DynamicCompressEncoder(:shock_arm, x) |&gt;
                                    x -&gt; MarkovKEncoder(2, x) |&gt;
                                    x -&gt; VectorEncoder(x, intercept = true),
                                    target = ShockArmEncoder() |&gt; LevelEncoder);

input, target, shock = preprocess(preprocessor, tracks[end])</code></pre><p>With this <code>preprocessor</code>, <code>input</code> is a list of vectors with one-hot encoding of the arm, <code>target</code> is a list of levelcodes of the next arm and <code>shock</code> is a list of average number of shocks per time step. Instead of roughly <span>$10^4$</span> time steps as in the raw data <code>tracks[end]</code>, the <code>DynamicCompressEncoder</code> compressed the subsequent time steps where the fly was in the same abstract state (e.g. in the shock arm) into one step, such that the input, target and shock sequences have now an approximate length of 50.</p><h2 id="Fitting-a-reinforcement-learning-agent"><a class="docs-heading-anchor" href="#Fitting-a-reinforcement-learning-agent">Fitting a reinforcement learning agent</a><a id="Fitting-a-reinforcement-learning-agent-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting-a-reinforcement-learning-agent" title="Permalink"></a></h2><p>Next we define a simple policy gradient agent to fit the data and compute the log-probability of the data given the model and some default parameters that include the discount factor, the learning rate and the initial transition probabilities between abstract states.</p><pre><code class="language-julia hljs">import FlyRL: Model, PolicyGradientAgent, params, logprob

model = Model(PolicyGradientAgent(Din = length(input[1]),
                                  Dout = length(FlyRL.levels(preprocessor.target.encoder)[1])),
                                  preprocessor);
θ = params(model) # some default parameters
logprob(model, tracks[end], θ)</code></pre><p>Let us now find the parameters that optimize the log-probability.</p><pre><code class="language-julia hljs">import FlyRL: train
result = train(model, tracks[end], θ, maxtime = 20, print_interval = 3)</code></pre><p>The log-probability with the fitted parameters is much higher than the value we obtained above.</p><pre><code class="language-julia hljs">logprob(model, tracks[end], result.params)</code></pre><h2 id="Generate-simulated-data"><a class="docs-heading-anchor" href="#Generate-simulated-data">Generate simulated data</a><a id="Generate-simulated-data-1"></a><a class="docs-heading-anchor-permalink" href="#Generate-simulated-data" title="Permalink"></a></h2><p>We can now use the fitted model to obtain simulated tracks.</p><pre><code class="language-julia hljs">import FlyRL: Environment, in_shock_arm, simulate

env = Environment(; preprocessor, shock = in_shock_arm);
x, s, a, logp = simulate(model.agent, env, result.params, 50)</code></pre><p>We can look at the simulation result by decoding the states <code>x</code></p><pre><code class="language-julia hljs">import FlyRL: decode

decode(preprocessor.input, x) |&gt; DataFrame</code></pre><p>Let us compare the simulated data to the recorded data</p><pre><code class="language-julia hljs">import FlyRL: plot_compare_probs

plot_compare_probs(decode(preprocessor.input, input).shock_arm,
                   decode(preprocessor.input, x).shock_arm)</code></pre><p><img src="../images/summary_stats1.png" alt/></p><p>The top row shows the visitation counts of the different arms in the recorded data and the bottom row shows them for one simulated trial. The first column shows the visitation counts over the whole trajectory (from relative time 0 to relative time 1). The middle row shows the visitation count for the first half of the trial and the last column shows the visitations counts for the second half. We see that the visitation count of the shock arm went down from the first to the second half, both in the recording (top) and the simulation (bottom). Because the simulations are stochastic, each simulated trial will look different, but on average a reduction of the visits to the shock arm is visible.</p><h2 id="Model-fitting-for-data-analysis"><a class="docs-heading-anchor" href="#Model-fitting-for-data-analysis">Model-fitting for data analysis</a><a id="Model-fitting-for-data-analysis-1"></a><a class="docs-heading-anchor-permalink" href="#Model-fitting-for-data-analysis" title="Permalink"></a></h2><p>Let us fit a few recorded tracks and look at the learning rates and discount factors.</p><pre><code class="language-julia hljs">function fit_lr_and_gamma(model, tracks)
    η = Float64[]
    γ = Float64[]
    for track2fit in tracks
        θ = params(model)
        res = train(model, track2fit, θ, maxtime = 10, print_interval = 9)
        push!(η, res.params.η)
        push!(γ, FlyRL.sigmoid(res.params.logitγ))
    end
    (; η, γ)
end
lr_and_gamma = fit_lr_and_gamma(model, tracks) # this may take some time</code></pre><p>We plot now some summary statistics of the data, together with the fitted parameters.</p><pre><code class="language-julia hljs">import FlyRL: plot_summaries
import FlyRL: RelativeVisitsToShockArm, RelativeTimeInShockArm, ChangeOf
using CairoMakie

function plot_stats_and_fits(tracks, lr_and_gamma;
        summaries = (RelativeTimeInShockArm(), ChangeOf(RelativeTimeInShockArm()),
                     RelativeVisitsToShockArm(), ChangeOf(RelativeVisitsToShockArm())),
        f = Figure(resolution = (1000, 400)))
    sp = sortperm(lr_and_gamma.η)
    plot_summaries(tracks; f, sortperm = sp, summaries)
    ax = Axis(f[1, length(summaries) + 1], ylabel = &quot;sign(η) ⋅ log(1 + |η|)&quot;, xlabel = &quot;track id&quot;)
    scatter!(ax, eachindex(lr_and_gamma.η), sign.(lr_and_gamma.η[sp]) .* log.(1 .+ abs.(lr_and_gamma.η[sp])))
    hlines!(ax, 0.)
    ax = Axis(f[1, length(summaries) + 2], ylabel = &quot;γ&quot;, xlabel = &quot;track id&quot;)
    scatter!(ax, eachindex(lr_and_gamma.γ), lr_and_gamma.γ[sp])
    f
end
plot_stats_and_fits(tracks, lr_and_gamma)</code></pre><p><img src="../images/summary_stats2.png" alt/> The tracks are sorted by ascending learning rate (5th panel). Not surprisingly, the learning rate seems to correlate with the change of relative visits to the shock arm. There is no obvious pattern for the discount factor <span>$\gamma$</span>.</p><p>The largest learning rate was obtained for a track, where the shocked arm was visited once and never again. <img src="../images/track7.png" alt/></p><p>A negative learning rate was obtained for a track where the fly alternated only between one neutral arm and the shock arm. Note that the simple abstract model we are using here is not capable of capturing the longer durations spent in the neutral arm. <img src="../images/track18.png" alt/></p><p>Do the differences in learning rate (or other statistics) indicate that there are fundamental differences between the different flies, or could <span>$N$</span> copies of the exact same fly lead to the same observed differences in learning rates etc., simply because action selection is random and the trials are of limited length? In simulations we can create multiple runs of the exact same model and only vary the initial conditions and the seed of the pseudo-random number generator. In the following we use the fitted parameters found in <a href="#Fitting-a-reinforcement-learning-agent">Fitting a reinforcement learning agent</a> and we simulate tracks that have the same duration as the recorded tracks.</p><pre><code class="language-julia hljs">function simulated_tracks(model, env, θ, Ts)
    res = []
    for T in Ts
        x, s, = simulate(model.agent, env, θ, T)
        df = decode(model.preprocessor.input, x[2:end]) |&gt; DataFrame
        df.shock = s
        push!(res, select(df, [:shock_arm, :shock]))
    end
    res
end
Ts = length.(first.(preprocess.(Ref(preprocessor), tracks)))
sim_tracks = simulated_tracks(model, env, result.params, Ts)
sim_lr_and_gamma = fit_lr_and_gamma(model, sim_tracks) # this may take some time
plot_stats_and_fits(sim_tracks, sim_lr_and_gamma,
        summaries = (RelativeVisitsToShockArm(), ChangeOf(RelativeVisitsToShockArm())))</code></pre><p><img src="../images/summary_stats3.png" alt/> We see indeed a large variability between different simulated runs with exactly the same model. Note that we do not plot the relative time spent in the shock arm, because our abstract model does not simulate the durations spent in each arm.</p><p>Could we even get similar behaviour, if the learning rate were 0?</p><pre><code class="language-julia hljs">newparams = copy(result.params)
newparams.η = 0.
sim_tracks2 = simulated_tracks(model, env, newparams, Ts)
sim_lr_and_gamma2 = fit_lr_and_gamma(model, sim_tracks2) # this may take some time
plot_stats_and_fits(sim_tracks2, sim_lr_and_gamma2,
        summaries = (RelativeVisitsToShockArm(), ChangeOf(RelativeVisitsToShockArm())))</code></pre><p><img src="../images/summary_stats4.png" alt/> One does indeed get similar differences between the different simulated tracks. In contrast to the simulations with positive learning rates, however, many fitted learning rates are close to zero and there is roughly an equal number of strongly positive and strongly negative learning rates.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Introduction</a><a class="docs-footer-nextpage" href="../detailed_model/">Detailed Model »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Wednesday 20 September 2023 00:43">Wednesday 20 September 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
